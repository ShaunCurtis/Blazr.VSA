@namespace Blazr.App.UI

@inject IJSRuntime Js

<PageTitle>@this.FormTitle</PageTitle>

<div class="modal-header">
    <div class="h4">
        @this.FormTitle
    </div>
</div>

<LoadingSpinner Loading="_loading">

    <EditForm EditContext=this.EditContext OnValidSubmit=this.OnSave>

        <div class="modal-body px-3">

            <BlazrFluentValidator TRecord="InvoiceItemRecordMutor" TValidator="InvoiceItemRecordMutorValidator" />
            <BlazrEditStateTracker LockNavigation=this.LockNavigation />

            <div class="row">

                <div class="col-12 col-md-8 col-xl-4 mb-2">
                    <BlazrTextViewControl Label="Id" Value="@this.EditMutor.BaseRecord.Id" />
                </div>

            </div>

            <div class="row">

                <BlazrTextControl class="form-control mb-2"
                                  SetFirstFocus
                                  UpdateOnInput
                                  ColumnCss="col-12 col-xl-8 mb-2"
                                  Label="Name"
                                  @bind-Value="this.EditMutor.Description" />

            </div>
            <div class="row">

                <BlazrNumberControl class="form-control mb-2"
                                    UpdateOnInput
                                    ColumnCss="col-4 col-md-4 col-xl-4 mb-2"
                                    Label="Amount £"
                                    @bind-Value="this.EditMutor.Amount" />

            </div>

        </div>

        <div class="modal-footer bg-light">

            <EditFormButtons SaveOnSubmit
                             ColumnCss="col-12 text-end"
                             Options=this.editFormButtonsOptions
                             DirtyExit=this.OnExit
                             Exit=this.OnExit
                             IsNewRecord=this.IsNewRecord
                             Reset=this.ResetRecord
                             Delete=this.OnDeleteAsync />

        </div>

    </EditForm>

</LoadingSpinner>

@code {
    [CascadingParameter] private InvoiceEntityMutor EntityMutor { get; set; } = default!;
    [CascadingParameter] private IModalDialog? ModalDialog { get; set; }
    [Parameter] public InvoiceItemId Uid { get; set; } = InvoiceItemId.NewId();
    [Parameter] public bool LockNavigation { get; set; } = true;

    private Return LastResult { get; set; } = Return.Success();
    private InvoiceItemRecordMutor EditMutor { get; set; } = default!;
    private EditContext EditContext { get; set; } = default!;
    private EditFormButtonsOptions editFormButtonsOptions = new();
    private bool _loading = true;
    private string FormTitle = $"Invoice Item Editor";

    private bool IsNewRecord => this.Uid.IsNew || this.Uid.IsDefault;

    protected override void OnInitialized()
    {
        this.EditMutor = this.EntityMutor.GetInvoiceItemRecordMutor(this.Uid);
        this.EditContext = new EditContext(EditMutor);
        this.EditContext.OnFieldChanged += OnEditStateMayHaveChanged;

        _loading = false;
    }

    private async Task OnDeleteAsync()
    {
        this.LastResult = await this.ConfirmDeleteAsync()
            .BindAsync(() => EntityMutor.Dispatch(DeleteInvoiceItemAction.Create(EditMutor.Record).Dispatcher))
            .NotifyAsync(this.OnExit);
    }

    private async Task<Return> ConfirmDeleteAsync()
        => await Js.InvokeAsync<bool>("confirm", "Are you sure you want to delete this item?")
            ? Return.Success()    
            : Return.Failure("The user aborted the deletion");

    private void OnSave()
    {
        this.LastResult = EntityMutor.Dispatch(SaveInvoiceItemAction.Create(EditMutor.Record).Dispatcher)
            .Notify(this.OnExit);
    }

    private void ResetRecord()
    {
        this.EditMutor.Reset();
        this.EditContext.MarkAsUnmodified();
        this.EditContext.Validate();
    }

    protected virtual void OnExit()
        => ModalDialog?.Close(new ModalResult());

    protected void OnEditStateMayHaveChanged(object? sender, EventArgs e)
        => this.StateHasChanged();

    public void Dispose()
    =>  Null.Read(this.EditContext)
        .ThenIfNotNull(() => this.EditContext!.OnFieldChanged -= OnEditStateMayHaveChanged);
}

